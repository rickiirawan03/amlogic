name: Build OpenWrt HG680FJ (S905X2)

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Versi Kernel"
        required: true
        default: "6.6.119"
      openwrt_target:
        description: "Target SoC (s905x2)"
        required: true
        default: "s905x2"

env:
  REPO_URL: https://github.com/ophub/amlogic-s9xxx-openwrt
  REPO_BRANCH: main

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Inisialisasi Lingkungan
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y git-core git-lfs tree devscripts git-buildpackage pigz
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean

    - name: Clone Source Code Ophub
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH build_dir

    - name: Persiapan Eksekusi Remake
      run: |
        cd build_dir
        # Pastikan file remake ada dan berikan izin eksekusi
        if [ -f "remake" ]; then
          sudo chmod +x remake
          echo "File 'remake' siap digunakan."
        else
          echo "ERROR: File 'remake' tidak ditemukan!"
          ls -R
          exit 1
        fi

    - name: Konfigurasi dan Build Firmware
      id: build_firmware
      run: |
        cd build_dir
        
        # Menggunakan ./remake sesuai struktur baru Ophub
        # -d: Default config
        # -b: Board (s905x2)
        # -k: Kernel version
        sudo ./remake -d -b "${{ github.event.inputs.openwrt_target }}" -k "${{ github.event.inputs.openwrt_kernel }}"
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organisasi File Output
      id: organize
      if: steps.build_firmware.outputs.status == 'success'
      run: |
        # Folder output di struktur baru biasanya tetap di 'out'
        if [ -d "build_dir/out" ]; then
          cd build_dir/out
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        else
          echo "Folder out tidak ditemukan, mencoba mencari file .img.gz"
          find build_dir -name "*.img.gz"
        fi

    - name: Upload Artifact Firmware
      uses: actions/upload-artifact@v4
      if: steps.build_firmware.outputs.status == 'success'
      with:
        name: OpenWrt_HG680FJ_${{ github.event.inputs.openwrt_kernel }}
        path: ${{ env.FIRMWARE_PATH }}/*
        retention-days: 3
