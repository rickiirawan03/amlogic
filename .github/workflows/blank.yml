name: Build OpenWrt HG680FJ (S905X2)

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "Versi Kernel"
        required: true
        default: "6.6.119"
      openwrt_target:
        description: "Target SoC"
        required: true
        default: "s905x2"

env:
  REPO_URL: https://github.com/ophub/amlogic-s9xxx-openwrt
  REPO_BRANCH: main
  # Link Rootfs Resmi 24.10.5
  ROOTFS_URL: https://downloads.openwrt.org/releases/24.10.5/targets/armsr/armv8/openwrt-24.10.5-armsr-armv8-rootfs.tar.gz

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Persiapan Lingkungan
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y git-core git-lfs tree devscripts git-buildpackage pigz curl wget zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean

    - name: Clone Ophub Script
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH build_dir

    - name: Download & Rename Rootfs
      run: |
        mkdir -p build_dir/openwrt-armsr
        # Download dan beri nama generic agar terbaca oleh skrip remake
        wget -t 5 -T 30 "${{ env.ROOTFS_URL }}" -O build_dir/openwrt-armsr/openwrt_armsr_generic_rootfs.tar.gz
        
        echo "Isi folder openwrt-armsr:"
        ls -lh build_dir/openwrt-armsr/

    - name: Build Firmware
      id: build_firmware
      run: |
        cd build_dir
        sudo chmod +x remake
        # Menjalankan build. Kita arahkan output log ke file agar bisa dicek jika gagal
        sudo -E ./remake -b "${{ github.event.inputs.openwrt_target }}" -k "${{ github.event.inputs.openwrt_kernel }}"
        
        # Cek apakah folder out tercipta
        if [ -d "out" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "FAILED: Folder 'out' tidak ditemukan setelah build!"
          exit 1
        fi

    - name: Simpan Hasil Build
      if: steps.build_firmware.outputs.status == 'success'
      run: |
        mkdir -p deploy
        # Cari file img.gz di folder build_dir/out
        find build_dir/out -name "*.img.gz" -exec cp {} deploy/ \;
        
        # Cek jika file berhasil dipindah
        if [ -z "$(ls -A deploy)" ]; then
           echo "Gagal menemukan file .img.gz di folder out!"
           exit 1
        fi
        echo "FIRMWARE_NAME=$(ls deploy | head -n 1)" >> $GITHUB_ENV

    - name: Upload Ke Artifact
      uses: actions/upload-artifact@v4
      if: steps.build_firmware.outputs.status == 'success'
      with:
        name: ${{ env.FIRMWARE_NAME }}
        path: deploy/*.img.gz
        retention-days: 7
